(()=>{const e=(new Date).toISOString().split("T")[0];document.getElementById("date").setAttribute("max",e);const t=initializeApp({apiKey:"AIzaSyAXt5UCawojL8OlicQt-16f9Tu_Yof8RFg",authDomain:"timesheet-app-84034.firebaseapp.com",projectId:"timesheet-app-84034",storageBucket:"timesheet-app-84034.appspot.com",messagingSenderId:"1001231652285",appId:"1:1001231652285:web:104b6d6466d9a992c76ed4",measurementId:"G-SNLELR3XVN"}),n=getAuth(t),o=getFirestore(t),d=document.querySelector("#login-form"),l=document.querySelector("#signup-form"),s=document.querySelector("#timesheet-form-container"),c=document.querySelector("#leave-form-container"),a=document.querySelector("#logout"),r=document.querySelector("#back"),i=document.getElementById("signup"),u=document.getElementById("signup-modal"),m=document.getElementById("login"),y=document.getElementById("profile"),p=document.getElementById("login-modal"),g=document.getElementById("close-login-modal"),h=document.getElementById("close-signup-modal"),E=document.querySelector(".home-section"),v=document.getElementById("add-timesheet-button"),f=document.getElementById("add-leave-button"),I=document.querySelector(".card-container"),k=document.querySelector(".view-timesheet-card"),B=document.querySelector(".add-timesheet-card"),b=document.querySelector(".add-leave-card"),L=document.getElementById("timesheet-container");function C(e){const t=document.getElementById("notification-container"),n=document.createElement("div");n.textContent=e,n.classList.add("notification"),t.appendChild(n),setTimeout((()=>{t.removeChild(n)}),3e3)}function D(){const e=document.cookie.split(";");for(let t of e){const[e,n]=t.trim().split("=");if("user"===e)return decodeURIComponent(n)}return null}i.addEventListener("click",(function(e){e.preventDefault(),u.style.display="block"})),m.addEventListener("click",(function(e){e.preventDefault(),p.style.display="block",d.style.display="block"})),g.addEventListener("click",(function(){p.style.display="none"})),h.addEventListener("click",(function(){u.style.display="none"})),v.addEventListener("click",(function(e){s.style.display="flex",I.style.display="none",r.style.display="block"})),f.addEventListener("click",(function(e){c.style.display="flex",I.style.display="none",r.style.display="block"})),r.addEventListener("click",(function(e){e.preventDefault(),L.style.display="none",I.style.display="flex",s.style.display="none",c.style.display="none"})),l.addEventListener("submit",(function(e){e.preventDefault();const t=document.getElementById("email").value,l=document.getElementById("admin-toggle").checked,c=document.getElementById("password").value;createUserWithEmailAndPassword(n,t,c).then((e=>{const n=e.user,c=collection(o,"users");addDoc(c,{userId:n.uid,email:t,isAdmin:l,date:new Date}).then((e=>{C("User has registered successfully"),console.log("user entry added successfully",e),console.log("User logged in:",n),d.style.display="none",s.style.display="none",a.style.display="block",document.getElementById("profile").style.display="block",document.getElementById("profile").textContent=l?`${t} (Admin)`:`${t}`,u.style.display="none",i.style.display="none",m.style.display="none",E.style.display="none",k.style.display="block",B.style.display="block",b.style.display="block",I.style.display="flex"})).catch((e=>{console.error("Error adding user entry entry: ",e)}))})).catch((e=>{e.code;const t=e.message;console.error("Login error:",t)}))})),d.addEventListener("submit",(function(e){e.preventDefault();const t=document.getElementById("username").value,l=document.getElementById("password").value;console.log("Email:",t),signInWithEmailAndPassword(n,t,l).then((e=>{const n=e.user,l=query(collection(o,"users"),where("userId","==",n.uid));getDocs(l).then((e=>{if(e.empty)return void alert("User not found");const o=e.docs[0].data().isAdmin;console.log("User logged in:",n),C("User has Logged in successfully"),a.style.display="block",document.getElementById("profile").style.display="block",document.getElementById("profile").textContent=o?`${t} (Admin)`:`${t}`,p.style.display="none",m.style.display="none",E.style.display="none",i.style.display="none",k.style.display="block",B.style.display="block",b.style.display="block",d.style.display="block",I.style.display="flex"})).catch((e=>{e.code;const t=e.message;console.error("Fetching user role error:",t)}))})).catch((e=>{e.code;const t=e.message;console.error("Login error:",t)}))})),a.addEventListener("click",(function(e){e.preventDefault(),signOut(n).then((e=>{console.log("User Logged out"),C("Logged out successfully!"),m.style.display="block",i.style.display="block",a.style.display="none",s.style.display="none",document.getElementById("profile").textContent="",E.style.display="block",I.style.display="none",r.style.display="none",p.style.display="none",L.style.display="none",d.style.display="none",c.style.display="none",y.style.display="none"})).catch((e=>{e.code;const t=e.message;console.error("Logout error:",t)}))})),c.addEventListener("submit",(async function(e){e.preventDefault();const t=D();t||alert("Login token has expired! Please login again");const n=new Date(document.getElementById("start-date").value),d=new Date(document.getElementById("end-date").value),l=document.getElementById("project").value,s=document.getElementById("description").value,c=document.getElementById("email-file"),a=function(e,t){const n=t-e;return Math.round(n/864e5)}(n,d);if(a<0)return void alert("Please choose the date correctly! End date should be more thant start date");const r=c.files[0];if(!r)return void alert("Please select a file to upload");const i=getStorage(),u=r.name,m=ref(i,`email_attachments/${u}`),y=await uploadBytes(m,r),p=await getDownloadURL(y.ref),g=collection(o,"timesheet");addDoc(g,{userId:t,entryType:"Leave",startDate:n,attachment:p,endDate:d,duration:a,description:s,project:l,approvalStatus:"Pending"}).then((e=>{console.log("Leave entry added successfully",e),C("Leave has been added successfully"),document.getElementById("start-date").value="",document.getElementById("end-date").value="",document.getElementById("duration").value="",document.getElementById("email-file").value="",document.getElementById("project").value="",document.getElementById("description").value=""})).catch((e=>{console.error("Error adding leave entry: ",e)}))})),s.addEventListener("submit",(function(e){e.preventDefault();const t=D();t||alert("Login token has expired! Please login again");const n=document.getElementById("date").value,d=document.getElementById("hours").value,l=document.getElementById("project").value,s=document.getElementById("description").value,c=document.getElementById("task").value,a=collection(o,"timesheet");addDoc(a,{userId:t,entryType:"Work Hours",date:n,hours:d,project:l,description:s,project:l,task:c,approvalStatus:"Pending"}).then((e=>{console.log("Timesheet entry added successfully",e),C("Timesheet has been added successfully"),document.getElementById("date").value="",document.getElementById("hours").value="",document.getElementById("project").value="",document.getElementById("task").value=""})).catch((e=>{console.error("Error adding timesheet entry: ",e)}))})),k.addEventListener("click",(function(e){L.innerHTML="",L.style.display="block";const t=D(),n=query(collection(o,"users"),where("userId","==",t));getDocs(n).then((e=>{if(e.empty)return void alert("User not found");const n=e.docs[0].data().isAdmin,d=query(collection(o,"timesheet"),where("userId","==",t),orderBy("date","desc")),l=collection(o,"timesheet");getDocs(n?l:d).then((e=>{I.style.display="none",r.style.display="block";const t=document.createElement("table");t.classList.add("timesheet-table");const d=document.createElement("tr");d.innerHTML="\n                    <th>Project</th>\n                    <th>Date</th>\n                    <th>Duration</th>\n                    <th>Task</th>\n                    <th>Entry Type</th>\n                    <th>Approval Status</th>\n                    <th>Action</th> \n                ",t.appendChild(d),e.forEach((e=>{const d=e.data(),l=document.createElement("tr");l.dataset.docId=e.id;const s=[document.createElement("td"),document.createElement("td"),document.createElement("td"),document.createElement("td"),document.createElement("td"),document.createElement("td"),document.createElement("td")];s[0].textContent=d.project,s[1].textContent=d.date||`${new Date(1e3*d.startDate.seconds).toISOString().split("T")[0]} to ${new Date(1e3*d.endDate.seconds).toISOString().split("T")[0]}`,s[2].textContent=d.hours?`${d.hours} hours`:`${d.duration} days`,s[3].textContent=d.task,s[4].textContent=d.entryType,s[5].textContent=d.approvalStatus;for(let e=5;e<s.length-1;e++){const t=s[e];"Pending"===t.textContent?t.classList.add("pending"):"Approved"===t.textContent?t.classList.add("approved"):"Rejected"===t.textContent&&t.classList.add("rejected")}if(n&&"Pending"===d.approvalStatus){const e=document.createElement("div");e.classList.add("action-container");const t=document.createElement("button");t.textContent="Approve",t.classList.add("approve-button"),t.onclick=()=>{const e=l.dataset.docId,t=doc(o,"timesheet",e);updateDoc(t,{approvalStatus:"Approved"}).then((()=>{C("Timesheet has been approved"),console.log("Timesheet entry approved:",e)})).catch((e=>{console.error("Error approving timesheet entry:",e)}))},e.appendChild(t);const n=document.createElement("button");n.textContent="Reject",n.classList.add("reject-button"),n.onclick=()=>{const e=l.dataset.docId,t=doc(o,"timesheet",e);updateDoc(t,{approvalStatus:"Rejected"}).then((()=>{console.log("Timesheet entry Rejected:",e),C("Timesheet has been rejected")})).catch((e=>{console.error("Error Rejecting timesheet entry:",e)}))},e.appendChild(n),s[6].appendChild(e)}else s[6].textContent="N/A";s.forEach((e=>l.appendChild(e))),t.appendChild(l)})),L.appendChild(t)})).catch((e=>{console.error("Error fetching timesheet data: ",e)}))}))})),onAuthStateChanged(n,(e=>{e?function(e,t,n){const o=new Date;o.setTime(o.getTime()+2592e6),document.cookie=`user=${encodeURIComponent(t)};expires=${o.toUTCString()};path=/`}(0,e.uid):("user",document.cookie="user=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;")}))})();